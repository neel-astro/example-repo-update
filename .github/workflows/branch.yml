name: Astronomer CI - Deploy code (Multiple Branches)

    on:
      push:
        branches: [dev]
      pull_request:
        types:
          - closed
        branches: [main]

    jobs:
      deployment-type:
        runs-on: ubuntu-latest
          steps:
          # Determine if only dags have changes 
        - name: Get Deployment Type
          run: |
            OUTPUT=$(git diff --name-only HEAD^ HEAD)
            DAGS_DEPLOY=FALSE
            REGULAR_DEPLOY=FALSE
            local IFS=$'\n'
            local lines=($OUTPUT)
            local i
            for (( i=0; i<${#lines[@]}; i++ )) ; do
                if [[ "${lines[$i]}" == *"dags/"* ]]
                then
                    DAGS_DEPLOY=TRUE
                else
                    REGULAR_DEPLOY=TRUE
                fi
            done

            echo "DAGS_DEPLOY=$DAGS_DEPLOY" >> $GITHUB_OUTPUT
            echo "REGULAR_DEPLOY=$REGULAR_DEPLOY" >> $GITHUB_OUTPUT
          id: deployment-type
      dev-push:
        if: github.ref == 'refs/heads/dev'
        env:
          ## Sets DEV Deployment API key credentials as environment variables
          ASTRONOMER_KEY_ID: ${{ secrets.DEV_ASTRONOMER_KEY_ID }}
          ASTRONOMER_KEY_SECRET: ${{ secrets.DEV_ASTRONOMER_KEY_SECRET }}
        runs-on: ubuntu-latest
        needs: deployment-type
        steps:
          - name: checkout repo
            uses: actions/checkout@v2.3.4
          # If only DAGs changed do a DAG Deploy
          - name: DAG Deploy to Astro
            if: needs.deployment-type.outputs.DAGS_DEPLOY == 'true' && needs.deployment-type.outputs.REGULAR_DEPLOY == 'false'
            run: |
              curl -sSL https://install.astronomer.io | sudo bash -s -- v1.7.0
              astro deploy --dags
          # If any other files changed do a regular Deploy
          - name: Image and DAG Deploy to Astro
            if: needs.deployment-type.outputs.REGULAR_DEPLOY == 'true'
            run: |
              curl -sSL https://install.astronomer.io | sudo bash -s -- v1.7.0
              astro deploy
      prod-push:
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        env:
          ## Sets PROD Deployment API key credentials as environment variables
          ASTRONOMER_KEY_ID: ${{ secrets.PROD_ASTRONOMER_KEY_ID }}
          ASTRONOMER_KEY_SECRET: ${{ secrets.PROD_ASTRONOMER_KEY_SECRET }}
        runs-on: ubuntu-latest
        needs: job1
        steps:
          - name: checkout repo
            uses: actions/checkout@v2.3.4
          # If only DAGs changed do a DAG Deploy
          - name: DAG Deploy to Astro
            if: needs.deployment-type.outputs.DAGS_DEPLOY == 'true' && needs.deployment-type.outputs.REGULAR_DEPLOY == 'false'
            run: |
              curl -sSL https://install.astronomer.io | sudo bash -s -- v1.7.0
              astro deploy --dags
          # If any other files changed do a regular Deploy
          - name: Image and DAG Deploy to Astro
            if: needs.deployment-type.outputs.REGULAR_DEPLOY == 'true'
            run: |
              curl -sSL https://install.astronomer.io | sudo bash -s -- v1.7.0
              astro deploy